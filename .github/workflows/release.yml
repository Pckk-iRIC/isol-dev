name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Verify tag matches pyproject.toml version
        run: |
          python - <<'PY'
          from __future__ import annotations

          import os
          import re
          import sys
          import tomllib
          from pathlib import Path

          tag = os.environ["GITHUB_REF_NAME"]
          if not re.fullmatch(r"v\d+\.\d+\.\d+", tag):
            raise SystemExit(f"Tag must look like vX.Y.Z, got: {tag}")

          version = tomllib.loads(Path("pyproject.toml").read_text(encoding="utf-8"))["project"]["version"]
          expected = f"v{version}"
          if tag != expected:
            raise SystemExit(f"Tag {tag} does not match pyproject.toml version {version}")

          print(f"Tag {tag} matches pyproject.toml version {version}")
          PY

      - name: Install build tools
        run: python -m pip install --upgrade build

      - name: Generate release notes from CHANGELOG.md
        run: |
          python - <<'PY'
          from __future__ import annotations

          import os
          import re
          from pathlib import Path

          tag = os.environ["GITHUB_REF_NAME"]
          version = tag.removeprefix("v")
          changelog = Path("CHANGELOG.md").read_text(encoding="utf-8")

          pattern = re.compile(rf"^## \\[{re.escape(version)}\\].*?$", re.MULTILINE)
          match = pattern.search(changelog)
          if not match:
            raise SystemExit(f"Version {version} not found in CHANGELOG.md")

          start = match.start()
          after_header = changelog[match.end():]
          next_header = re.search(r"^## \\[", after_header, re.MULTILINE)
          end = match.end() + (next_header.start() if next_header else len(after_header))
          section = changelog[start:end].strip()

          output = Path("release_notes.md")
          output.write_text(section + "\n", encoding="utf-8")
          print(f"Wrote {output}")
          PY

      - name: Build
        run: python -m build

      - name: Upload assets to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          body_path: release_notes.md
          files: dist/*
